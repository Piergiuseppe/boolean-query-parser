<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boolean Query Parser ‚Äî Live Playground</title>
    <style>
        :root {
            --bg: #0d1117;
            --surface: #161b22;
            --border: #30363d;
            --text: #e6edf3;
            --text-muted: #8b949e;
            --accent: #58a6ff;
            --accent-hover: #79c0ff;
            --green: #3fb950;
            --red: #f85149;
            --orange: #d29922;
            --radius: 10px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 820px;
            margin: 0 auto;
            padding: 2rem 1.5rem 4rem;
        }

        /* ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ */
        header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.4rem;
            background: linear-gradient(135deg, var(--accent), var(--green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        header p {
            color: var(--text-muted);
            font-size: 0.95rem;
            max-width: 520px;
            margin: 0 auto 1rem;
        }

        .badges {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .badge {
            display: inline-block;
            font-size: 0.72rem;
            font-weight: 600;
            padding: 0.22rem 0.6rem;
            border-radius: 999px;
            text-decoration: none;
            letter-spacing: 0.02em;
        }

        .badge--pypi {
            background: #3572a5;
            color: #fff;
        }

        .badge--zero {
            background: var(--green);
            color: #000;
        }

        .badge--wasm {
            background: #654ff0;
            color: #fff;
        }

        /* ‚îÄ‚îÄ‚îÄ Card ‚îÄ‚îÄ‚îÄ */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1.25rem;
        }

        .card h2 {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }

        /* ‚îÄ‚îÄ‚îÄ Inputs ‚îÄ‚îÄ‚îÄ */
        label {
            display: block;
            font-size: 0.82rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 0.35rem;
        }

        input[type="text"], textarea {
            width: 100%;
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.65rem 0.85rem;
            font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(88,166,255,0.15);
        }

        textarea {
            resize: vertical;
            min-height: 140px;
            max-height: 400px;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* ‚îÄ‚îÄ‚îÄ Mode toggle ‚îÄ‚îÄ‚îÄ */
        .mode-toggle {
            display: flex;
            gap: 0;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
        }

        .mode-toggle button {
            flex: 1;
            padding: 0.5rem;
            background: transparent;
            color: var(--text-muted);
            border: none;
            cursor: pointer;
            font-size: 0.82rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .mode-toggle button.active {
            background: var(--accent);
            color: #fff;
        }

        .mode-toggle button:hover:not(.active) {
            background: var(--border);
            color: var(--text);
        }

        /* ‚îÄ‚îÄ‚îÄ Run button ‚îÄ‚îÄ‚îÄ */
        .run-btn {
            width: 100%;
            padding: 0.75rem;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .run-btn:hover:not(:disabled) {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .run-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .run-btn .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ‚îÄ‚îÄ‚îÄ Results ‚îÄ‚îÄ‚îÄ */
        .results-section {
            display: none;
        }

        .results-section.visible {
            display: block;
        }

        .result-block {
            margin-bottom: 1rem;
        }

        .result-block:last-child {
            margin-bottom: 0;
        }

        .result-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.35rem;
        }

        .result-label--ast { color: var(--orange); }
        .result-label--match { color: var(--green); }
        .result-label--nomatch { color: var(--red); }
        .result-label--error { color: var(--red); }
        .result-label--filtered { color: var(--accent); }

        .result-content {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.75rem 1rem;
            font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            word-break: break-word;
            overflow-x: auto;
        }

        .result-content.match {
            border-color: var(--green);
            color: var(--green);
        }

        .result-content.nomatch {
            border-color: var(--red);
            color: var(--red);
        }

        .result-content.error {
            border-color: var(--red);
            color: var(--red);
        }

        .result-content.filtered-list li {
            padding: 0.2rem 0;
            list-style: none;
        }

        .result-content.filtered-list li::before {
            content: "‚úì ";
            color: var(--green);
        }

        .result-content.filtered-list {
            padding-left: 0.75rem;
        }

        .result-stats {
            font-size: 0.78rem;
            color: var(--text-muted);
            margin-top: 0.35rem;
        }

        /* ‚îÄ‚îÄ‚îÄ Examples ‚îÄ‚îÄ‚îÄ */
        .examples-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.6rem;
        }

        .example-btn {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.6rem 0.8rem;
            color: var(--text);
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            overflow: hidden;
            min-width: 0;
        }

        .example-btn:hover {
            border-color: var(--accent);
            background: rgba(88,166,255,0.05);
        }

        .example-btn .eq {
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 0.78rem;
            color: var(--accent);
            display: block;
            margin-bottom: 0.2rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .example-btn .desc {
            font-size: 0.72rem;
            color: var(--text-muted);
        }

        /* ‚îÄ‚îÄ‚îÄ Loader overlay ‚îÄ‚îÄ‚îÄ */
        .loader-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: opacity 0.4s;
        }

        .loader-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loader-text {
            margin-top: 1.2rem;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .loader-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* ‚îÄ‚îÄ‚îÄ Footer ‚îÄ‚îÄ‚îÄ */
        footer {
            text-align: center;
            padding: 2rem 0;
            color: var(--text-muted);
            font-size: 0.78rem;
        }

        footer a {
            color: var(--accent);
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        /* ‚îÄ‚îÄ‚îÄ Syntax reference ‚îÄ‚îÄ‚îÄ */
        .syntax-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .syntax-table td {
            padding: 0.4rem 0.6rem;
            border-bottom: 1px solid var(--border);
        }

        .syntax-table td:first-child {
            font-family: 'SF Mono', 'Fira Code', monospace;
            color: var(--accent);
            white-space: nowrap;
            width: 40%;
        }

        .syntax-table td:last-child {
            color: var(--text-muted);
        }

        .syntax-table tr:last-child td {
            border-bottom: none;
        }

        /* ‚îÄ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ‚îÄ */
        @media (max-width: 600px) {
            .container { padding: 1.2rem 1rem 3rem; }
            header h1 { font-size: 1.5rem; }
            .examples-grid { grid-template-columns: 1fr; }
            .example-btn .eq { font-size: 0.72rem; }
        }
    </style>
</head>
<body>

<!-- Loading overlay (shown while Pyodide loads) -->
<div class="loader-overlay" id="loader">
    <div class="loader-spinner"></div>
    <div class="loader-text">Loading Python runtime‚Ä¶</div>
</div>

<div class="container">

    <!-- Header -->
    <header>
        <h1>Boolean Query Parser</h1>
        <p>A lightweight, zero-dependency Python query parser ‚Äî running live in your browser via WebAssembly.</p>
        <div class="badges">
            <a class="badge badge--pypi" href="https://pypi.org/project/boolean-query-parser/" target="_blank">üì¶ PyPI</a>
            <span class="badge badge--zero">0 dependencies</span>
            <span class="badge badge--wasm">üêç Pyodide WASM</span>
        </div>
    </header>

    <!-- Query input -->
    <div class="card">
        <h2>Query</h2>
        <div class="input-group">
            <label for="query-input">Boolean expression</label>
            <input type="text" id="query-input" placeholder='e.g. python AND (django OR flask) NOT ruby' autocomplete="off" spellcheck="false">
            <div class="input-hint">Supports: <code>AND</code>, <code>OR</code>, <code>NOT</code>, parentheses, regex <code>/pattern/flags</code>, implicit AND</div>
        </div>

        <div class="mode-toggle">
            <button class="active" data-mode="single" onclick="setMode('single')">Single Text</button>
            <button data-mode="list" onclick="setMode('list')">List of Texts</button>
        </div>

        <div class="input-group" id="single-input-group">
            <label for="single-input">Text to evaluate</label>
            <input type="text" id="single-input" placeholder="e.g. I love programming in python with flask" autocomplete="off" spellcheck="false">
        </div>

        <div class="input-group" id="list-input-group" style="display:none">
            <label for="list-input">Texts to filter (one per line)</label>
            <textarea id="list-input" placeholder="python django web app&#10;ruby rails project&#10;python flask API&#10;java spring boot&#10;python numpy data science"></textarea>
        </div>

        <button class="run-btn" id="run-btn" onclick="runQuery()" disabled>
            <span id="run-label">‚ñ∂ Run Query</span>
        </button>
    </div>

    <!-- Results -->
    <div class="card results-section" id="results-section">
        <h2>Results</h2>
        <div id="results-container"></div>
    </div>

    <!-- Examples: Basic -->
    <div class="card">
        <h2>Basic Examples</h2>
        <div class="examples-grid" id="examples-grid-basic"></div>
    </div>

    <!-- Examples: Advanced -->
    <div class="card">
        <h2>Advanced &amp; Edge Cases</h2>
        <div class="examples-grid" id="examples-grid-advanced"></div>
    </div>

    <!-- Syntax Reference -->
    <div class="card">
        <h2>Syntax Reference</h2>
        <table class="syntax-table">
            <tr><td>python flask</td><td>Implicit AND ‚Äî both terms must match</td></tr>
            <tr><td>python AND flask</td><td>Explicit AND ‚Äî both terms must match</td></tr>
            <tr><td>python OR ruby</td><td>Either term must match</td></tr>
            <tr><td>NOT java</td><td>Term must <em>not</em> be present</td></tr>
            <tr><td>python AND (django OR flask)</td><td>Grouping with parentheses</td></tr>
            <tr><td>/\d+\.\d+/</td><td>Regular expression matching</td></tr>
            <tr><td>/error/i</td><td>Case-insensitive regex</td></tr>
            <tr><td>"hello world"</td><td>Quoted phrase (exact match)</td></tr>
        </table>
    </div>

    <footer>
        Built with <a href="https://pyodide.org" target="_blank">Pyodide</a> ‚Äî
        Source on <a href="https://github.com/piergiuseppe/boolean-query-parser" target="_blank">GitHub</a> ‚Äî
        Install: <code>pip install boolean-query-parser</code>
    </footer>
</div>

<script>
    // ‚îÄ‚îÄ‚îÄ Basic Examples ‚îÄ‚îÄ‚îÄ
    const BASIC_EXAMPLES = [
        {
            query: 'python AND (django OR flask)',
            mode: 'list',
            text: '',
            list: 'python django web app\nruby rails project\npython flask API server\njava spring boot\npython numpy data science',
            desc: 'AND + OR operators'
        },
        {
            query: 'python NOT ruby',
            mode: 'single',
            text: 'I code in python and javascript',
            list: '',
            desc: 'NOT operator'
        },
        {
            query: '/\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}/',
            mode: 'list',
            text: '',
            list: 'Server IP is 192.168.1.1\nNo address here\nConnect to 10.0.0.1 for access\nHostname: server.local',
            desc: 'Regex ‚Äî match IP addresses'
        },
        {
            query: 'python flask',
            mode: 'single',
            text: 'Building a python flask REST API',
            list: '',
            desc: 'Implicit AND'
        },
        {
            query: '/error/i OR /warn/i',
            mode: 'list',
            text: '',
            list: 'ERROR: disk full\nInfo: server started\nWarning: high memory\nDebug: query parsed\nERROR: timeout reached',
            desc: 'Case-insensitive regex + OR'
        },
        {
            query: '(backend OR frontend) AND NOT intern',
            mode: 'list',
            text: '',
            list: 'Senior backend engineer\nFrontend intern position\nBackend developer role\nFrontend lead engineer\nIntern project assistant',
            desc: 'Complex nested query'
        }
    ];

    // ‚îÄ‚îÄ‚îÄ Advanced Examples ‚îÄ‚îÄ‚îÄ
    const ADVANCED_EXAMPLES = [
        {
            query: '((/python/i OR /java/i) AND (/senior/i OR /lead/i)) AND NOT (/intern/i OR /junior/i) AND /\\d+/',
            mode: 'list',
            text: '',
            list: 'Senior Python Developer ‚Äî 8 years experience in Django and Flask\nJunior Java Developer ‚Äî fresh graduate, Spring Boot\nLead Java Architect ‚Äî 12 years, microservices and Kafka\nSenior Ruby Engineer ‚Äî 5 years, Rails expert\nPython Intern ‚Äî university project, no production experience\nSenior Python ML Engineer ‚Äî 3 years, TensorFlow and PyTorch\nLead Python DevOps ‚Äî 10 years, Kubernetes and CI/CD pipelines\nJava Junior Consultant ‚Äî 1 year, basic REST APIs\nFreelance Designer ‚Äî 4 years, Figma and Sketch',
            desc: 'üî• Deep nesting: regex + NOT + implicit AND'
        },
        {
            query: '/[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}/ AND NOT /\\.(xyz|top|buzz)\\b/',
            mode: 'list',
            text: '',
            list: 'Contact us at support@example.com for help\nSend invoice to billing@company.co.uk ASAP\nNo email here, just a phone: +1-555-0199\nReach out: admin@sketchy-domain.xyz (suspicious)\nThe CEO email is john.doe@enterprise.org\nSpam from deals@promo.buzz ‚Äî ignore this\nInternal: devops_team@internal.dev ‚Äî urgent ticket #4821\nFollow us @twitter (not an email!)\nApply at careers@startup.io ‚Äî we are hiring 5 engineers',
            desc: 'üìß Email regex + exclude shady TLDs'
        },
        {
            query: '(/^\\[ERROR\\]/m OR /^\\[FATAL\\]/m) AND /\\d{4}-\\d{2}-\\d{2}/ AND NOT /healthcheck/i',
            mode: 'list',
            text: '',
            list: '[ERROR] 2025-03-15 12:04:33 ‚Äî Connection to database timed out after 30s\n[INFO] 2025-03-15 12:04:34 ‚Äî Retrying connection (attempt 2/5)\n[FATAL] 2025-03-15 12:04:35 ‚Äî Out of memory: heap allocation failed (512MB limit)\n[ERROR] 2025-03-15 12:05:00 ‚Äî Healthcheck endpoint /api/health returned 503\n[WARN] 2025-03-15 12:05:01 ‚Äî Disk usage at 94%, cleanup recommended\n[FATAL] 2025-03-15 12:05:02 ‚Äî Kernel panic: unable to mount /dev/sda1\n[ERROR] Missing timestamp ‚Äî malformed log entry, no date here\n[DEBUG] 2025-03-15 12:05:10 ‚Äî GC completed in 45ms\n[ERROR] 2025-03-15 12:06:00 ‚Äî SSL certificate expired for *.prod.internal',
            desc: 'üìã Log analysis: multiline regex + date filter'
        },
        {
            query: '((/https?:\\/\\//i OR /www\\./) AND (/\\.com/ OR /\\.org/ OR /\\.io/)) AND NOT (/localhost/ OR /127\\.0\\.0\\.1/ OR /example\\.com/)',
            mode: 'list',
            text: '',
            list: 'Visit https://github.com/piergiuseppe for open source projects\nDocumentation at http://docs.example.com/v2/api (placeholder URL)\nOur site: www.startup.io ‚Äî launching next quarter\nTest server: http://localhost:3000/api/health\nSee https://wikipedia.org/wiki/Boolean_algebra for background\nInternal: http://127.0.0.1:8080/debug/pprof\nBlog post: www.techblog.com/2025/03/boolean-parsing-deep-dive\nPlain text, no URLs here at all\nhttps://pypi.org/project/boolean-query-parser/',
            desc: 'üåê URL detection ‚Äî exclude localhost/placeholders'
        },
        {
            query: '"stack overflow" OR ("runtime error" AND /line \\d+/)',
            mode: 'list',
            text: '',
            list: 'Traceback: runtime error at line 42 in main.py ‚Äî variable x is undefined\nstack overflow detected: recursive call depth exceeded 1000 frames\nWarning: memory usage high but no overflow detected\nFailed with runtime error on line 128: division by zero in calculate_avg()\nEverything works fine, tests passed 248/248\nstack overflow in thread-7: infinite loop in event_handler()\nTypeError on line 15 ‚Äî not a runtime error, just wrong type\nruntime error: segfault ‚Äî but no line number available',
            desc: 'üí¨ Quoted phrases + regex line numbers'
        },
        {
            query: 'NOT NOT NOT python',
            mode: 'list',
            text: '',
            list: 'I love programming in python every day\njavascript is my favorite language\npython and rust are fast\nno relevant language mentioned here',
            desc: 'üß† Triple NOT (= NOT python, matches non-python texts)'
        },
        {
            query: '((((/\\d+\\.\\d+\\.\\d+/ AND NOT /0\\.0\\./) OR "release") AND (changelog OR update)) OR "breaking change")',
            mode: 'list',
            text: '',
            list: 'v2.1.0 changelog ‚Äî added implicit AND support and new regex flags\nRelease notes update for v1.0.2: bug fixes and performance improvements\nbreaking change: parse_query now raises QueryError instead of ValueError\nInternal refactor, no changelog entry needed for this commit\nVersion 0.0.1 update ‚Äî initial release, basic AND/OR/NOT support\nv3.5.2 changelog: fixed edge case in nested parentheses parsing\nRelease candidate update ‚Äî pending QA review, not final\nbreaking change in API: apply_query returns bool|list instead of always list\nBug fix for v1.2.3 ‚Äî no update to public API, changelog not required',
            desc: 'üì¶ Semver filter + release notes ‚Äî heavy nesting'
        },
        {
            query: '/^.{0,50}$/ AND (/[A-Z]/ AND /[a-z]/ AND /[0-9]/ AND /[!@#$%^&*]/)',
            mode: 'list',
            text: '',
            list: 'MyP@ssw0rd!\npassword123\nABC123!@#\nhello\nC0mpl3x!Pass\nnospecialchar1A\n!!@@##$$\nGoodP4$$word\nThis is a very long string that exceeds fifty characters and should be filtered out even if it has A1! mixed case',
            desc: 'üîê Password validator ‚Äî length + complexity regex'
        }
    ];

    // ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ
    let currentMode = 'single';
    let pyodide = null;

    // ‚îÄ‚îÄ‚îÄ Mode toggle ‚îÄ‚îÄ‚îÄ
    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.mode-toggle button').forEach(b => {
            b.classList.toggle('active', b.dataset.mode === mode);
        });
        document.getElementById('single-input-group').style.display = mode === 'single' ? '' : 'none';
        document.getElementById('list-input-group').style.display = mode === 'list' ? '' : 'none';
    }

    // ‚îÄ‚îÄ‚îÄ Build example buttons ‚îÄ‚îÄ‚îÄ
    function buildExamples() {
        _buildGrid('examples-grid-basic', BASIC_EXAMPLES, 'basic');
        _buildGrid('examples-grid-advanced', ADVANCED_EXAMPLES, 'advanced');
    }

    function _buildGrid(gridId, examples, prefix) {
        const grid = document.getElementById(gridId);
        examples.forEach((ex, i) => {
            const btn = document.createElement('button');
            btn.className = 'example-btn';
            btn.innerHTML = `<span class="eq">${escapeHtml(ex.query)}</span><span class="desc">${ex.desc}</span>`;
            btn.onclick = () => loadExample(prefix, i);
            grid.appendChild(btn);
        });
    }

    function loadExample(prefix, index) {
        const ex = prefix === 'basic' ? BASIC_EXAMPLES[index] : ADVANCED_EXAMPLES[index];
        document.getElementById('query-input').value = ex.query;
        setMode(ex.mode);
        if (ex.mode === 'single') {
            document.getElementById('single-input').value = ex.text;
        } else {
            document.getElementById('list-input').value = ex.list;
        }
        runQuery();
    }

    function escapeHtml(s) {
        return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    // ‚îÄ‚îÄ‚îÄ Load Pyodide + parser ‚îÄ‚îÄ‚îÄ
    async function initPyodide() {
        const loader = document.getElementById('loader');
        try {
            pyodide = await loadPyodide();

            // Load the parser source code into Pyodide
            const parserSource = await fetch('parser.py').then(r => r.text());
            pyodide.runPython(parserSource);

            // Helper function to run queries from JS
            pyodide.runPython(`
import json as _json

def _run_playground(query_str, text_data_json, mode):
    """Run a query and return JSON results for the playground."""
    result = {}
    try:
        ast = parse_query(query_str)
        result['ast'] = repr(ast)

        if mode == 'single':
            text = _json.loads(text_data_json)
            match = apply_query(ast, text)
            result['match'] = match
        else:
            texts = _json.loads(text_data_json)
            filtered = apply_query(ast, texts)
            result['filtered'] = filtered
            result['total'] = len(texts)

        result['ok'] = True
    except Exception as e:
        result['ok'] = False
        result['error'] = str(e)
    return _json.dumps(result)
`);

            document.getElementById('run-btn').disabled = false;
            loader.classList.add('hidden');

        } catch (err) {
            loader.innerHTML = `
                <div style="color: var(--red); text-align: center; padding: 2rem;">
                    <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">Failed to load Python runtime</p>
                    <p style="color: var(--text-muted);">${escapeHtml(err.message)}</p>
                </div>`;
        }
    }

    // ‚îÄ‚îÄ‚îÄ Run Query ‚îÄ‚îÄ‚îÄ
    async function runQuery() {
        const queryStr = document.getElementById('query-input').value.trim();
        if (!queryStr || !pyodide) return;

        const resultsSection = document.getElementById('results-section');
        const resultsContainer = document.getElementById('results-container');
        resultsSection.classList.add('visible');

        let textDataJson, mode;
        if (currentMode === 'single') {
            const text = document.getElementById('single-input').value;
            textDataJson = JSON.stringify(text);
            mode = 'single';
        } else {
            const lines = document.getElementById('list-input').value.split('\n').filter(l => l.trim());
            textDataJson = JSON.stringify(lines);
            mode = 'list';
        }

        try {
            const resultJson = pyodide.runPython(
                `_run_playground(${JSON.stringify(queryStr)}, ${JSON.stringify(textDataJson)}, ${JSON.stringify(mode)})`
            );
            const result = JSON.parse(resultJson);

            if (!result.ok) {
                resultsContainer.innerHTML = `
                    <div class="result-block">
                        <div class="result-label result-label--error">Error</div>
                        <div class="result-content error">${escapeHtml(result.error)}</div>
                    </div>`;
                return;
            }

            let html = `
                <div class="result-block">
                    <div class="result-label result-label--ast">Parsed AST</div>
                    <div class="result-content">${escapeHtml(result.ast)}</div>
                </div>`;

            if (mode === 'single') {
                const isMatch = result.match;
                html += `
                    <div class="result-block">
                        <div class="result-label ${isMatch ? 'result-label--match' : 'result-label--nomatch'}">
                            ${isMatch ? '‚úì Match' : '‚úó No Match'}
                        </div>
                        <div class="result-content ${isMatch ? 'match' : 'nomatch'}">
                            ${isMatch ? 'The text matches the query.' : 'The text does not match the query.'}
                        </div>
                    </div>`;
            } else {
                const filtered = result.filtered || [];
                const total = result.total || 0;
                html += `
                    <div class="result-block">
                        <div class="result-label result-label--filtered">
                            Filtered Results (${filtered.length} / ${total})
                        </div>
                        <div class="result-content filtered-list">
                            ${filtered.length > 0
                                ? '<ul>' + filtered.map(t => `<li>${escapeHtml(t)}</li>`).join('') + '</ul>'
                                : '<span style="color: var(--text-muted)">No texts matched the query.</span>'
                            }
                        </div>
                        <div class="result-stats">${filtered.length} of ${total} texts matched</div>
                    </div>`;
            }

            resultsContainer.innerHTML = html;

        } catch (err) {
            resultsContainer.innerHTML = `
                <div class="result-block">
                    <div class="result-label result-label--error">Runtime Error</div>
                    <div class="result-content error">${escapeHtml(err.message)}</div>
                </div>`;
        }
    }

    // ‚îÄ‚îÄ‚îÄ Keyboard shortcut ‚îÄ‚îÄ‚îÄ
    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            e.preventDefault();
            runQuery();
        }
    });

    // ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ
    buildExamples();
</script>

<!-- Load Pyodide from CDN -->
<script src="https://cdn.jsdelivr.net/pyodide/v0.27.2/full/pyodide.js"></script>
<script>initPyodide();</script>

</body>
</html>
